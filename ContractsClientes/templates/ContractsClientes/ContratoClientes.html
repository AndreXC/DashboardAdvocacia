<!DOCTYPE html>
<html lang="pt-BR">

{% load static %}
{% include "includes/header.html" %}
<link rel="stylesheet" href="{% static 'Contract/css/style.css' %}">
<link rel="stylesheet" href="{% static 'ContractsClientes/css/ContartoClientes.css' %}">

<style>
    /* --- ESTILOS PARA A NOVA FUNCIONALIDADE --- */

    /* Estilo para a linha da tabela selecionada */
    tbody tr.selected {
        background-color: #1f2937;

    }

    /* Garante que o cursor mude para indicar que a linha é clicável */
    #contract-list-tbody tr {
        cursor: pointer;
    }

    /* Container principal para os botões flutuantes */
    .fab-container {
        position: fixed;
        bottom: 32px;
        right: 32px;
        z-index: 100;
    }

    /* Estilo base para os botões flutuantes (FAB) */
    .fab {
        background-color: #007bff;
        color: white;
        border: none;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .fab:hover {
        background-color: #0056b3;
        transform: scale(1.05);
    }

    /* Menu de ações que aparece acima do botão principal */
    .fab-actions {
        position: absolute;
        bottom: 75px;
        right: 8px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-items: center;
        visibility: hidden;
        opacity: 0;
        transform: translateY(20px) scale(0.9);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    /* Classe para tornar o menu de ações visível */
    .fab-actions.visible {
        visibility: visible;
        opacity: 1;
        transform: translateY(0) scale(1);
    }

    /* Estilo para os itens de ação individuais (círculos menores) */
    .fab-action-item {
        background-color: #ffffff;
        color: #555;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        /* Remove sublinhado de links */
    }

    .fab-action-item:hover {
        transform: scale(1.1);
        color: #007bff;
    }
</style>

<body>
    {% include "includes/sidebar.html" %}

    <main class="main-content">
        <div class="content-container-app">
            <header>
                <h1>Acordos com Clientes</h1>
                {% include "includes/theme.html" %}
            </header>

            {% include "includes/search.html" %}

            <div class="table-container" style="width: 100% !important;">
                <table>
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Modelo do Contrato</th>
                            <th>Protocolo do Serviço</th>
                            <th>Data de Criação</th>
                            <th>Status</th>
                            <th>Link de Assinatura</th>
                        </tr>
                    </thead>
                    <tbody id="contract-list-tbody">
                        {% for contract in contracts %}
                        <!-- Adicionados os data-attributes para o JavaScript -->
                        <tr data-contract-id="{{ contract.id }}" data-status="{{ contract.status }}"
                            data-pdf-url="{% if contract.status == 'SIGNED' %}{% url 'ContractsClientes:view_pdf' contract.id %}{% endif %}"
                            data-sign-link="{{ request.scheme }}://{{ request.get_host }}{% url 'ContractsClientes:sign' contract.signature_link_id %}">

                            <td>{{ contract.client.full_name }}</td>
                            <td>{{ contract.template.title }}</td>
                            <td>{{ contract.service.protocolo }}</td>
                            <td>{{ contract.created_at|date:"d/m/Y H:i" }}</td>
                            <td>
                                {% if contract.status == 'SIGNED' %}
                                <span class="status-badge status-signed">
                                    <span class="status-dot"></span> Assinado
                                </span>
                                {% else %}
                                <span class="status-badge status-pending">
                                    <span class="status-dot"></span> Pendente
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if contract.status == 'PENDING' %}
                                <div class="copy-link-wrapper">
                                    <input type="text" class="link-input"
                                        value="{{ request.scheme }}://{{ request.get_host }}{% url 'ContractsClientes:sign' contract.signature_link_id %}"
                                        readonly>
                                    <button type="button" class="copy-btn" title="Copiar link">
                                        <i class="fa-regular fa-copy"></i>
                                    </button>
                                </div>
                                {% else %}
                                Assinado
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">Nenhum contrato gerado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Container para os Botões Flutuantes (FAB) -->
            <div class="fab-container">
                <!-- Botão de Ações (inicialmente escondido) -->
                <div id="actions-fab-container" style="display: none;">
                    <div id="fab-actions-menu" class="fab-actions">
                        <!-- As ações serão inseridas aqui pelo JavaScript -->
                    </div>
                    <button id="actions-fab" class="fab">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                    </button>
                </div>

                <!-- Botão Adicionar Novo (substituído pelo seu) -->
                <button id="add-new-Contrato-cliente" title="Adicionar Novo Contrato" class="fab">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
        </div>
    </main>

    {% include "ContractsClientes/Modal/AddNewContratoCliente.html" %}

    {% block scripts %}
    <script src="{% static 'ContractsClientes/js/ModalContractClientes.js' %}"></script>
    <script src="{% static 'ContractsClientes/js/CopyLinkModalCliente.js' %}"></script>
    <script src="{% static 'resources/js/includes/theme.js' %}"></script>
    <script src="{% static 'ContractsClientes/js/ModalSubmitCreateNewContrato.js' %}"></script>


    <script>
        // --- SCRIPT PARA A NOVA FUNCIONALIDADE DE AÇÕES ---
        document.addEventListener('DOMContentLoaded', function () {
            const tableBody = document.getElementById('contract-list-tbody');
            // Verifica se a tabela existe antes de adicionar listeners
            if (!tableBody) return;

            const rows = tableBody.querySelectorAll('tr');
            const addFab = document.getElementById('add-new-Contrato-cliente');
            const actionsFabContainer = document.getElementById('actions-fab-container');
            const actionsFab = document.getElementById('actions-fab');
            const actionsMenu = document.getElementById('fab-actions-menu');

            let selectedRow = null;

            rows.forEach(row => {
                // Ignora a linha de "Nenhum contrato gerado"
                if (row.querySelector('td[colspan="5"]')) return;

                row.addEventListener('click', function () {
                    if (selectedRow === this) {
                        this.classList.remove('selected');
                        selectedRow = null;
                        showAddButton();
                    } else {
                        if (selectedRow) {
                            selectedRow.classList.remove('selected');
                        }
                        this.classList.add('selected');
                        selectedRow = this;
                        showActionsButton();
                        updateActionButtons(this);
                    }
                });
            });

            function showAddButton() {
                addFab.style.display = 'flex';
                actionsFabContainer.style.display = 'none';
                actionsMenu.classList.remove('visible');
            }

            function showActionsButton() {
                addFab.style.display = 'none';
                actionsFabContainer.style.display = 'block';
            }

            actionsFab.addEventListener('click', function (event) {
                event.stopPropagation();
                actionsMenu.classList.toggle('visible');
            });

            document.addEventListener('click', function (event) {
                // Fecha o menu se o clique for fora do container de ações
                if (!actionsFabContainer.contains(event.target)) {
                    actionsMenu.classList.remove('visible');
                }
            });

            function updateActionButtons(row) {
                const status = row.dataset.status;
                const pdfUrl = row.dataset.pdfUrl;
                const signLink = row.dataset.signLink;

                actionsMenu.innerHTML = ''; // Limpa ações antigas

                if (status === 'SIGNED') {
                    actionsMenu.innerHTML = `
                        <a href="${pdfUrl}" target="_blank" class="fab-action-item" title="Prévia do acordo em PDF">
                            <i class="fa-solid fa-file-pdf"></i>
                        </a>
                        <button class="fab-action-item share-button" data-link="${signLink}" title="Compartilhe seu acordo agora">
                            <i class="fa-solid fa-share-alt"></i>
                        </button>
                    `;
                } else { // PENDING
                    actionsMenu.innerHTML = `
                        <a href="${signLink}" target="_blank" class="fab-action-item" title="Abrir link em nova guia">
                            <i class="fa-solid fa-up-right-from-square"></i>
                        </a>
                    `;
                }
            }

            // Lógica para o botão de compartilhar
            actionsMenu.addEventListener('click', function (event) {
                const shareButton = event.target.closest('.share-button');
                if (shareButton) {
                    const link = shareButton.dataset.link;
                    navigator.clipboard.writeText(link).then(() => {
                        alert('Link copiado para a área de transferência!');
                        actionsMenu.classList.remove('visible'); // Fecha o menu após copiar
                    }).catch(err => {
                        console.error('Erro ao copiar link: ', err);
                    });
                }
            });
        });
    </script>
    {% endblock %}
</body>

</html>