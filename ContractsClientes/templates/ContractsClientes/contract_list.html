{% block title %}Lista de Contratos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Contratos Gerados</h1>
    <a href="{% url 'ContractsClientes:create' %}" class="btn btn-primary">Gerar Novo Contrato</a>
</div>

<div class="card p-4">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>Cliente</th>
                <th>Modelo</th>
                <th>Status</th>
                <th>Data de Criação</th>
                <th>Link de Assinatura</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for contract in contracts %}
            <tr>
                <td>{{ contract.client.full_name }}</td>
                <td>{{ contract.template.title }}</td>
                <td>
                    {% if contract.status == 'SIGNED' %}
                    <span class="badge bg-success">Assinado</span>
                    {% else %}
                    <span class="badge bg-warning">Pendente</span>
                    {% endif %}
                </td>
                <td>{{ contract.created_at|date:"d/m/Y H:i" }}</td>
                <td>
                    {% if contract.status == 'PENDING' %}
                    <input type="text" class="form-control form-control-sm"
                        value="{{ request.scheme }}://{{ request.get_host }}{% url 'ContractsClientes:sign' contract.signature_link_id %}"
                        readonly>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    {% if contract.status == 'SIGNED' %}
                    <a href="{% url 'ContractsClientes:view_pdf' contract.id %}" target="_blank"
                        class="btn btn-sm btn-info">
                        Ver PDF
                    </a>
                    {% else %}
                    <button class="btn btn-sm btn-secondary share-button"
                        data-link="{{ request.scheme }}://{{ request.get_host }}{% url 'ContractsClientes:sign' contract.signature_link_id %}">
                        Compartilhar Link
                    </button>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="text-center">Nenhum contrato gerado.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Encontra todos os botões de compartilhamento
        const shareButtons = document.querySelectorAll('.share-button');

        shareButtons.forEach(button => {
            button.addEventListener('click', function () {
                const contractLink = this.dataset.link;

                // Verifica se a API de compartilhamento está disponível
                if (navigator.share) {
                    navigator.share({
                        title: 'Assinatura de Contrato',
                        text: 'Olá! Por favor, assine este contrato clicando no link abaixo.',
                        url: contractLink
                    }).then(() => {
                        console.log('Compartilhamento bem-sucedido');
                    }).catch((error) => {
                        console.error('Erro ao compartilhar:', error);
                    });
                } else {
                    // Fallback para navegadores que não suportam a API
                    alert(`Copie e compartilhe este link: ${contractLink}`);
                }
            });
        });
    });
</script>
{% endblock %}