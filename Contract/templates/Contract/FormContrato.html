{% block head %}
{# Link para o Font Awesome (ícones) #}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}


{% block content %}
<style>
:root {
    --sidebar-width: 280px;
    --animation-speed: 0.4s;
    --animation-easing: cubic-bezier(0.65, 0, 0.35, 1);
    --header-height: 65px; /* NOVO: Variável para a altura dos cabeçalhos */
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #ffffff;
    margin: 0;
    padding: 0;
    color: #333;
    overflow: hidden;
}

.app-container {
    display: flex;
    height: 100vh;
    position: relative;
}


/* --- 1. SIDEBAR E ANIMAÇÃO --- */
.sidebar {
    width: var(--sidebar-width);
    min-width: var(--sidebar-width);
    background-color: #fafafa;
    border-right: 1px solid #e0e0e0;
    display: flex;
    flex-direction: column;
    margin-left: 0;
    transition: margin-left var(--animation-speed) var(--animation-easing);
}
.app-container.sidebar-collapsed .sidebar {
    min-width: 0;
    margin-left: calc(-1 * var(--sidebar-width));
}


/* --- 2. CABEÇALHOS ALINHADOS (A MUDANÇA PRINCIPAL ESTÁ AQUI) --- */

/* NOVO: Regra agrupada para garantir que ambos tenham o MESMO TAMANHO */
.sidebar-header,
#toolbar-container {
    height: var(--header-height);
    box-sizing: border-box; /* Garante que padding/borda não alterem a altura final */
    display: flex;
    align-items: center; /* Centraliza o conteúdo verticalmente */
    border-bottom: 1px solid #e0e0e0;
    background-color: #fafafa;
    flex-shrink: 0; /* Impede que encolham */
}

/* MODIFICADO: Removemos as propriedades que agora são compartilhadas */
.sidebar-header {
    padding: 0 1.5rem; /* Apenas padding horizontal */
    justify-content: space-between;
}
.sidebar-header h3 {
    margin: 0;
    color: #1e3a8a;
    font-size: 1.25rem;
}

/* MODIFICADO: Removemos as propriedades que agora são compartilhadas */
#toolbar-container {
    padding: 0 10px; /* Apenas padding horizontal */
}


/* --- Conteúdo da Sidebar --- */
.sidebar-header, .page-list {
    transition: opacity calc(var(--animation-speed) / 2) ease;
}
.page-list {
    padding: 1.5rem;
    opacity: 1;
    /* Ao ABRIR: a animação de opacidade espera um pouco */
    transition-delay: calc(var(--animation-speed) / 2);
}
.app-container.sidebar-collapsed .sidebar-header,
.app-container.sidebar-collapsed .page-list {
    opacity: 0;
    transition-delay: 0s;
}


/* --- Botão de Toggle --- */
.sidebar-toggle-btn {
    position: absolute; top: 50%; left: var(--sidebar-width); transform: translate(-50%, -50%); z-index: 1001;
    background-color: #1e3a8a; color: white; border: 2px solid #fafafa; border-radius: 50%;
    width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: left var(--animation-speed) var(--animation-easing), transform var(--animation-speed) var(--animation-easing);
}
.sidebar-toggle-btn i { font-size: 14px; }
.app-container.sidebar-collapsed .sidebar-toggle-btn { left: 0; transform: translate(50%, -50%); }
.sidebar-toggle-btn .icon-closed { display: none; }
.app-container.sidebar-collapsed .sidebar-toggle-btn .icon-open { display: none; }
.app-container.sidebar-collapsed .sidebar-toggle-btn .icon-closed { display: inline-block; }


/* --- Layout do Editor --- */
.main-content {
    flex-grow: 1; display: flex; flex-direction: column; overflow: hidden;
    background-color: #eef0f4;
}
#editor {
    flex-grow: 1; overflow-y: auto; padding: 2rem; box-sizing: border-box;
    background: #ffffff;
}
#editor .ck-editor__editable_inline {
    background: #ffffff; border: 1px solid #d1d5db; box-shadow: 0 0 10px rgba(0,0,0,0.1);
    margin: 0 auto; padding: 2rem 4rem !important; width: 8.5in;
    min-height: 11in; box-sizing: border-box;
}


/* --- Estilos das Miniaturas na Sidebar --- */
.btn-icon { background-color: #1e3a8a; color: #ffffff; width: 36px; height: 36px; border-radius: 8px; display: flex; justify-content: center; align-items: center; padding: 0; border: none; cursor: pointer; transition: background-color 0.3s; }
.btn-icon:hover { background-color: #334dbc; }
.page-list { list-style: none; margin: 0; flex-grow: 1; overflow-y: auto; }
.page-list li { padding: 1rem 0; margin-bottom: 0.5rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; border-radius: 8px; transition: background-color 0.2s; }
.page-list li:hover { background-color: #eef0f4; }
.page-thumbnail { background-color: #ffffff; width: 140px; height: 180px; border: 1px solid #d1d5db; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.08); overflow: hidden; transition: border-color 0.2s; position: relative; }
.thumbnail-scaler { width: 595px; height: 842px; transform-origin: top left; transform: scale(0.235); background-color: #fff; overflow: hidden; }
.thumbnail-content { padding: 40px; color: #333; font-family: 'Times New Roman', Times, serif; line-height: 1.5; }
.thumbnail-content h1 { font-size: 2em; }
.thumbnail-content p { font-size: 1em; }
.page-number { margin-top: 0.75rem; font-size: 0.875rem; font-weight: 600; color: #4b5563; }
.page-list li.active .page-thumbnail { border: 3px solid #3b82f6; }
.page-list li.active .page-number { color: #3b82f6; }
.delete-btn { position: absolute; top: 5px; right: 5px; color: white; background-color: rgba(0, 0, 0, 0.5); border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; font-size: 12px; z-index: 10; }
.page-list li:hover .delete-btn { opacity: 1; }

#toolbar-container {
    display: flex;
    flex-direction: column;
    align-content: center;
    justify-content: center;
}

.button-group {
    display: flex;
    gap: 10px;

}

/* ... seu CSS existente ... */

/* Adicionado wrapper para botões no header */
.sidebar-header div {
    display: flex;
    gap: 0.5rem;
}

/* --- Estilos do Modal --- */
.modal-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}
.modal-container.visible {
    opacity: 1;
    pointer-events: auto;
}

.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
}

.modal-content {
    background-color: #fff;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    width: 90%;
    max-width: 500px;
    z-index: 1;
    transform: scale(0.95);
    transition: transform 0.3s ease;
}
.modal-container.visible .modal-content {
    transform: scale(1);
}

.modal-content h3 {
    margin-top: 0;
    color: #1e3a8a;
}
.modal-content p {
    color: #6b7280;
    line-height: 1.6;
}
.modal-content .form-group {
    margin-top: 1.5rem;
}
.modal-content input {
    width: 100%;
    box-sizing: border-box;
}
.error-message {
    color: #ef4444;
    font-size: 0.875rem;
    display: block;
    margin-top: 0.25rem;
    height: 1rem;
}

.modal-actions {
    margin-top: 1.5rem;
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
}
.modal-actions .btn-primary, .modal-actions .btn-secondary {
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    cursor: pointer;
}
.modal-actions .btn-primary {
    background-color: #1e3a8a;
    color: #fff;
}
.modal-actions .btn-primary:disabled {
    background-color: #9ca3af;
    cursor: not-allowed;
}
.modal-actions .btn-secondary {
    background-color: #e5e7eb;
    color: #374151;
}
</style>

<div class="app-container" id="appContainer">
    <button id="toggleSidebarBtn" class="sidebar-toggle-btn" title="Ocultar Páginas">
        <i class="fas fa-chevron-left icon-open"></i>
        <i class="fas fa-chevron-right icon-closed"></i>
    </button>

    <aside class="sidebar">
        <div class="sidebar-header">
            <h3>Páginas</h3>


            <div class="button-group">
                <button id="SaveContrato" class="btn btn-icon" title="Salvar Contrato">
                    <i class="fas fa-save"></i>
                </button>

                <button id="addPageBtn" class="btn btn-icon" title="Adicionar Nova Página">
                    <i class="fas fa-plus"></i>
                </button>

            </div>
        </div>
        <ul id="pageList" class="page-list"></ul>
    </aside>

    <main class="main-content">
        <div id="toolbar-container"></div>
        <div id="editor"></div>
    </main>

    <div class="modal-container" id="saveModal" style="display: none;">
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal-content">
        <h3>Salvar Modelo de Contrato</h3>
        <p>Digite um título para o seu modelo. Este título ajudará você a identificá-lo mais tarde.</p>
        <div class="form-group">
            <label for="contractTitleInput">Título do Modelo</label>
            <input type="text" id="contractTitleInput" placeholder="Ex: Contrato de Prestação de Serviços" />
            <small class="error-message" id="titleError"></small>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" id="modalCancelBtn">Cancelar</button>
            <button class="btn-primary" id="modalSaveBtn" disabled>Salvar Contrato</button>
        </div>
    </div>
</div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/decoupled-document/ckeditor.js"></script>
<script>
    // --- VARIÁVEIS GLOBAIS ---
    let editor;
    let pages = [];
    let currentPage = null;
    let contractId = null; // Guardará o ID do contrato que estamos editando

    // --- ELEMENTOS DO DOM ---
    const pageList = document.getElementById('pageList');
    const addPageBtn = document.getElementById('addPageBtn');
    const saveBtn = document.getElementById('SaveContrato');
    const saveModal = document.getElementById('saveModal');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const modalSaveBtn = document.getElementById('modalSaveBtn');
    const contractTitleInput = document.getElementById('contractTitleInput');
    const titleError = document.getElementById('titleError');
    const toggleBtn = document.getElementById('toggleSidebarBtn');
    const appContainer = document.getElementById('appContainer');

    // --- INICIALIZAÇÃO ---
    // Pega os dados do contrato passados pelo Django
    const contractData = {{ contract_json|safe }};

    function initializeApp() {
        if (contractData) {
            // Se estamos EDITANDO, carrega os dados
            contractId = contractData.id;
            contractTitleInput.value = contractData.title;
            try {
                pages = JSON.parse(contractData.content_html);
            } catch (e) {
                pages = [{ title: contractData.title, content: contractData.content_html }];
            }
            loadPage(0);
        } else {
            // Se estamos CRIANDO, começa com uma página em branco
            addPage();
        }
    }

    DecoupledEditor
        .create(document.querySelector('#editor'))
        .then(newEditor => {
            editor = newEditor;
            const toolbarContainer = document.querySelector('#toolbar-container');
            toolbarContainer.appendChild(editor.ui.view.toolbar.element);
            initializeApp();
        })
        .catch(error => console.error(error));


    // --- LÓGICA DO MODAL DE SALVAR ---
    function openModal() {
        titleError.textContent = '';
        saveModal.style.display = 'flex';
        setTimeout(() => saveModal.classList.add('visible'), 10);
        
        const currentModelTitle = contractTitleInput.value;
        if (!currentModelTitle && contractId) {
             contractTitleInput.value = contractData.title;
        } else if (pages.length > 0 && currentPage !== null) {
            const currentPageTitle = getTitleFromContent(pages[currentPage].content);
             if (contractTitleInput.value === '' && currentPageTitle !== 'Nova Página') {
                contractTitleInput.value = currentPageTitle;
            }
        }
        
        modalSaveBtn.disabled = contractTitleInput.value.trim() === '';
    }

    function closeModal() {
        saveModal.classList.remove('visible');
        setTimeout(() => saveModal.style.display = 'none', 300);
    }
    
    contractTitleInput.addEventListener('input', () => {
        if (contractTitleInput.value.trim() === '') {
            modalSaveBtn.disabled = true;
            titleError.textContent = 'O título é obrigatório.';
        } else {
            modalSaveBtn.disabled = false;
            titleError.textContent = '';
        }
    });

    saveBtn.addEventListener('click', openModal);
    modalOverlay.addEventListener('click', closeModal);
    modalCancelBtn.addEventListener('click', closeModal);

    // --- FUNÇÃO PARA PEGAR O CSRF TOKEN ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // --- LÓGICA DE SALVAR VIA API (FETCH) ---
    async function saveContract() {
        const title = contractTitleInput.value.trim();
        if (currentPage !== null && pages[currentPage] && editor) {
            pages[currentPage].content = editor.getData();
            pages[currentPage].title = getTitleFromContent(pages[currentPage].content);
        }
        const content_html = JSON.stringify(pages);

        try {
            const response = await fetch("{% url 'Contract:save_contract_api' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    id: contractId,
                    title: title,
                    content_html: content_html
                })
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message);
                contractId = result.contract_id;
                closeModal();
                const newUrl = `/editor/${result.contract_id}/`;
                history.pushState({ path: newUrl }, '', newUrl);
            } else {
                titleError.textContent = result.message;
            }
        } catch (error) {
            titleError.textContent = 'Ocorreu um erro de conexão.';
            console.error('Erro ao salvar:', error);
        }
    }

    modalSaveBtn.addEventListener('click', saveContract);


    // --- LÓGICA DE GERENCIAMENTO DE PÁGINAS ---
    function getTitleFromContent(content) {
        if (!content) return 'Nova Página';
        const plainText = content.replace(/<[^>]+>/g, '');
        const firstLine = plainText.trim().split('\n')[0];
        return firstLine.substring(0, 50) || 'Nova Página';
    }
    
    function renderPages() {
        pageList.innerHTML = '';
        pages.forEach((page, index) => {
            const li = document.createElement('li');
            li.className = currentPage === index ? 'active' : '';
            const pageTitle = `<h1>${page.title}</h1>`;
            const pageContent = page.content || '<p style.color="#9ca3af";>Página vazia...</p>';
            li.innerHTML = `
                <div class="page-thumbnail">
                    <div class="thumbnail-scaler">
                        <div class="thumbnail-content">
                            ${pageContent.includes('<h1>') ? '' : pageTitle}
                            ${pageContent}
                        </div>
                    </div>
                    <i class="fas fa-trash delete-btn"></i>
                </div>
                <div class="page-number">${index + 1}</div>
            `;
            li.addEventListener('click', () => loadPage(index));
            const deleteButton = li.querySelector('.delete-btn');
            deleteButton.addEventListener('click', (event) => { event.stopPropagation(); deletePage(index); });
            pageList.appendChild(li);
        });
    }

    function loadPage(index) {
        if (index < 0 || index >= pages.length) return;
        if (currentPage !== null && pages[currentPage] && editor) {
            pages[currentPage].content = editor.getData();
            pages[currentPage].title = getTitleFromContent(pages[currentPage].content);
        }
        currentPage = index;
        const page = pages[index];
        if (editor) { editor.setData(page.content || ''); }
        renderPages();
    }

    function addPage() {
        if (currentPage !== null && pages[currentPage] && editor) {
            pages[currentPage].content = editor.getData();
            pages[currentPage].title = getTitleFromContent(pages[currentPage].content);
        }
        pages.push({ title: 'Nova Página', content: '' });
        const newPageIndex = pages.length - 1;
        loadPage(newPageIndex);
    }

    function deletePage(index) {
        if (!confirm(`Tem certeza que deseja excluir a página ${index + 1}?`)) return;
        pages.splice(index, 1);
        if (pages.length === 0) { addPage(); }
        else { const newIndex = Math.max(0, index - 1); loadPage(newIndex); }
    }

    addPageBtn.addEventListener('click', addPage);
    toggleBtn.addEventListener('click', () => {
        appContainer.classList.toggle('sidebar-collapsed');
        const isCollapsed = appContainer.classList.contains('sidebar-collapsed');
        toggleBtn.title = isCollapsed ? 'Mostrar Páginas' : 'Ocultar Páginas';
    });
</script>
{% endblock %}